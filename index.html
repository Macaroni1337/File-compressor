<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Word DOCX Compressor (Target Size)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
  :root{color-scheme:light dark}
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px}
  .wrap{max-width:780px;margin:auto}
  h1{margin:0 0 .5rem}
  .card{border:1px solid #ccc;border-radius:14px;padding:16px}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  label{font-weight:600}
  input[type="range"]{width:240px}
  button{border:0;border-radius:10px;padding:.6rem 1rem;font-weight:700;cursor:pointer}
  .primary{background:#2563eb;color:#fff}
  .muted{opacity:.8}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .stats{margin-top:1rem;padding:.75rem;border-radius:10px;background:rgba(0,0,0,.05)}
  .err{color:#dc2626;font-weight:700}
  progress{width:100%;height:12px}
  .mode{display:flex;gap:1rem;flex-wrap:wrap;margin:.75rem 0}
  .mode > div{display:flex;gap:.5rem;align-items:center}
</style>
</head>
<body>
<div class="wrap">
  <h1>Word DOCX Compressor</h1>
  <div class="card">
    <p>Select a <strong>.docx</strong>. Choose <em>Lossless</em> or <em>Shrink Images</em> with a target size. Everything runs in your browser.</p>

    <div class="row">
      <input id="file" type="file" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
    </div>

    <div class="mode">
      <div>
        <input type="radio" name="mode" id="lossless" checked>
        <label for="lossless">Lossless (re-ZIP only)</label>
      </div>
      <div>
        <input type="radio" name="mode" id="shrink">
        <label for="shrink">Shrink Images (target size)</label>
      </div>
    </div>

    <div id="shrinkPanel" style="display:none">
      <div class="row">
        <label for="targetPct">Target size:</label>
        <input id="targetPct" type="range" min="20" max="90" value="50">
        <span id="targetPctLabel">50%</span>
      </div>
      <div class="row">
        <label for="maxDim">Max image dimension:</label>
        <select id="maxDim">
          <option value="0">Auto (no cap)</option>
          <option value="2400" selected>2400 px</option>
          <option value="1920">1920 px</option>
          <option value="1600">1600 px</option>
          <option value="1280">1280 px</option>
        </select>
        <span class="muted">Large images get downscaled if bigger than this.</span>
      </div>
      <p class="muted">Tip: 50% target is a good start. The tool iterates JPEG quality and downscales large images to approach your target without obvious visual loss.</p>
    </div>

    <div class="row" style="margin-top:.75rem">
      <button id="go" class="primary" disabled>Compress</button>
      <span id="sel" class="muted"></span>
    </div>

    <div id="work" class="stats" style="display:none">
      <p class="muted" id="phase">Working…</p>
      <progress id="prog" max="100" value="0"></progress>
    </div>

    <div id="out" class="stats" style="display:none"></div>
    <div id="err" class="stats err" style="display:none"></div>
  </div>

  <p class="muted" style="margin-top:1rem"><strong>Notes:</strong> DOCX is a ZIP of XML + media. Lossless re-ZIP rarely saves much. “Shrink Images” modifies images in <span class="mono">/word/media/</span>—often the main size driver.</p>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const fileInput = $('file');
const goBtn = $('go');
const out = $('out');
const err = $('err');
const work = $('work');
const phase = $('phase');
const prog = $('prog');
const sel = $('sel');
const lossless = $('lossless');
const shrink = $('shrink');
const shrinkPanel = $('shrinkPanel');
const targetPct = $('targetPct');
const targetPctLabel = $('targetPctLabel');
const maxDimSel = $('maxDim');

let file;

const prettyBytes=(b)=> {
  if(!isFinite(b)||b<0) return '?';
  const k=1024, u=['B','KB','MB','GB']; let i=0; while(b>=k&&i<u.length-1){b/=k;i++;}
  return `${b.toFixed(b<10&&i>0?2:0)} ${u[i]}`;
};

fileInput.addEventListener('change', () => {
  out.style.display = 'none'; err.style.display='none'; work.style.display='none';
  file = fileInput.files && fileInput.files[0];
  if (!file) { sel.textContent=''; goBtn.disabled=true; return; }
  if (!/\.docx$/i.test(file.name)) { sel.innerHTML=`Selected: <span class="mono">${file.name}</span> — not a .docx`; goBtn.disabled=true; return; }
  sel.innerHTML=`Selected: <span class="mono">${file.name}</span> — ${prettyBytes(file.size)}`;
  goBtn.disabled=false;
});

lossless.addEventListener('change', ()=>{ shrinkPanel.style.display=shrink.checked?'block':'none'; });
shrink.addEventListener('change', ()=>{ shrinkPanel.style.display=shrink.checked?'block':'none'; });
targetPct.addEventListener('input', ()=> targetPctLabel.textContent = targetPct.value + '%');

async function rezipLossless(zip) {
  const outZip = new JSZip();
  const files = Object.values(zip.files);
  let done=0, total=files.length||1;
  for (const f of files) {
    if (f.dir){ outZip.folder(f.name); continue; }
    const data = await f.async('uint8array');
    outZip.file(f.name, data, {binary:true, compression:'DEFLATE', compressionOptions:{level:9}, date: f.date||undefined});
    done++; prog.value = Math.round(done/total*100);
  }
  return await outZip.generateAsync({type:'blob', compression:'DEFLATE', compressionOptions:{level:9}});
}

async function blobToImageBitmap(blob){
  const url = URL.createObjectURL(blob);
  try {
    const img = await createImageBitmap(await (await fetch(url)).blob());
    return img;
  } f
